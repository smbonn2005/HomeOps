---
apiVersion: v1
kind: Service
metadata:
  name: unifi
spec:
  type: ClusterIP
  ports:
    - name: https
      protocol: TCP
      port: 443
      targetPort: https
---
apiVersion: v1
kind: Endpoints
metadata:
  name: unifi
subsets:
  - addresses:
      - ip: "192.168.1.1"
    ports:
      - name: https
        protocol: TCP
        port: 443
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: &app unifi
  annotations:
    gethomepage.dev/enabled: "true"
    gethomepage.dev/icon: unifi.png
    gethomepage.dev/name: Unifi UDM SE
    gethomepage.dev/group: Infrastructure
    gethomepage.dev/widget.type: unifi
    gethomepage.dev/widget.url: https://unifi.smbonn.me
    gethomepage.dev/widget.key: '{{HOMEPAGE_VAR_UNIFI_KEY}}'
spec:
  hostnames:
    - unifi.smbonn.me
  parentRefs:
    - name: envoy-internal
      namespace: networking
      port: 443
  rules:
    - backendRefs:
        - name: unifi
          port: 443
---
apiVersion: gateway.networking.k8s.io/v1alpha3
kind: BackendTLSPolicy
metadata:
  name: unifi
  namespace: networking
spec:
  targetRefs:
    - group: ""
      kind: Service
      name: unifi
  validation:
    hostname: unifi.local
    caCertificateRefs:
      # TODO: currently there's no way to disable cert validation on Gateway API
      - group: ""
        kind: ConfigMap
        name: unifi-tls-cert
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: unifi-tls-cert
data:
  ca.crt: |-
    -----BEGIN CERTIFICATE-----
    MIIDNTCCAh2gAwIBAgIJFTRiVp35xAKxMA0GCSqGSIb3DQEBCwUAMBYxFDASBgNV
    BAMTC3VuaWZpLmxvY2FsMB4XDTIzMTIxNDE0MTQxOVoXDTI2MDMxODE0MTQxOVow
    FjEUMBIGA1UEAxMLdW5pZmkubG9jYWwwggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAw
    ggEKAoIBAQCisSdak6P2UCsBXzRwCikpavrLQ6ASzxRoGw6qDd/QKBkV2FjsMNJM
    BZcVNDRcygRSSst0d+7cp5CTolvysZg2rW/xzgF5FovmYA758RxFmQiOoNDzeQOS
    0xNCZTMVfjYMP86+AmjrnxbUKydWku0Z3U70FbjK4etyGd8xnZxQgxguXCHdHbuU
    fvzf0qTBywhEwZ+1GZSK+8PCMujxq5j+qdASSIpESzzKDxSMsRNZ7QMEPofbtlJf
    X32jYJrcYHjK1iQjJ0QEQhYoINyUzbwy6HuS3AQXo5XyHVQLgVBNiMkR6moT1T9P
    5QRz+V+8I3sUSbboeSgrI2Yz8Py+WzVPAgMBAAGjgYUwgYIwCwYDVR0PBAQDAgL0
    MDEGA1UdJQQqMCgGCCsGAQUFBwMBBggrBgEFBQcDAgYIKwYBBQUHAwMGCCsGAQUF
    BwMIMEAGA1UdEQQ5MDeCC3VuaWZpLmxvY2Fsgglsb2NhbGhvc3SCBVs6OjFdhwR/
    AAABhxD+gAAAAAAAAAAAAAAAAAABMA0GCSqGSIb3DQEBCwUAA4IBAQCWwbiSDDHZ
    GNTyWCZ0HymG/V/qwsx9BAz0QZQhnVKNDR59exM1tVTAIDjTUlJwdqHYIRVbAVmt
    L11V2uHYzBR+7M84krhIa7uGH0Jv/c+gvCL0FeKT9WtAJ7lF4+E3tgJhqLafhCjs
    Xgsg0SF363dYT806e1LX06+aInK53c5e11tVBhppJvjFhWsUj5woG/p9ECujb3q/
    tOa5pNKpcieAR4vyE1IQvXqv2qJJPrEJGXFyfjZ4O8swJT9H/QEesGWwJCT3buJ7
    pBFK+wO1Tn2X792y6khg7EsFANgCqtfqRnr47xdtY6wt29RxU4rDzI6oFpqqXFA3
    9kgPJRk3/gxj
    -----END CERTIFICATE-----
---
apiVersion: gateway.envoyproxy.io/v1alpha1
kind: BackendTrafficPolicy
metadata:
  name: unifi-backend
  namespace: network
spec:
  targetRefs:
    - group: gateway.networking.k8s.io
      kind: HTTPRoute
      name: unifi
  useClientProtocol: true
  connection:
    bufferLimit: 8Mi
  timeout:
    http:
      requestTimeout: 0s
      connectionIdleTimeout: 3600s
